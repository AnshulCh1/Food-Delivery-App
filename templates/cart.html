{% extends "base.html" %}

{% block title %}Cart{% endblock %}

{% block content %}
<h1 class="my-4">Your Cart</h1>

<ul id="cart" class="list-group"></ul>
<button onclick="checkout()" class="btn btn-warning mt-3">Place Order</button>

<script>
let userHasDetails = false;

// First, fetch user details
fetch('/api/user/details')
  .then(res => res.json())
  .then(user => {
    if (!user.mobile_number || !user.address) {
      alert("Please complete your profile with mobile number and address to place an order.");
      userHasDetails = false;
    } else {
      userHasDetails = true;
    }
  });

// Then fetch cart data
fetch('/api/cart/view')
  .then(res => res.json())
  .then(data => {
    const cartList = document.getElementById('cart');
    if (data.length === 0) {
      cartList.innerHTML = `<li class="list-group-item">Your cart is empty.</li>`;
    } else {
      data.forEach(item => {
        cartList.innerHTML += `<li class="list-group-item">
            ${item.name} x ${item.quantity} = $${(item.price * item.quantity).toFixed(2)}
        </li>`;
      });
    }
  });

function checkout() {
    if (!userHasDetails) {
        alert("You must complete your profile (mobile number & address) before placing an order.");
        return;
    }

    fetch('/api/order/checkout', { method: 'POST' })
        .then(res => {
            if (!res.ok) {
                return res.json().then(err => { throw new Error(err.message); });
            }
            return res.json();
        })
        .then(data => alert(`Order placed! Total: $${data.total}`))
        .catch(err => alert("Error: " + err.message));
}
</script>
{% endblock %}
